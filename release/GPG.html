<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 from src/site/markdown/GPG.md at 2018-11-22
 | Rendered using Apache Maven Fluido Skin 1.7
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20181122" />
    <meta http-equiv="Content-Language" content="en" />
    <title>maven-build &#x2013; I. Install GPG</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.7.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
    <script type="text/javascript" src="./js/apache-maven-fluido-1.7.min.js"></script>
  </head>
  <body class="topBarEnabled">
    <div id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
            <ul class="nav">
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">DOCUMENTATION <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="README.html" title="README">README</a></li>
            <li><a href="GITFLOW_RELEASE.html" title="How to release Apache Maven projects">How to release Apache Maven projects</a></li>
            <li><a href="MVN_DEPLOY_PUBLISH_SEGREGATION.html" title="mvn deploy and artifacts publish segregation">mvn deploy and artifacts publish segregation</a></li>
            <li><a href="TRAVISCI.html" title="travis-ci build">travis-ci build</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Projects <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="build-docker/index.html" title="build-docker">build-docker</a></li>
            <li><a href="#" title="-----">-----</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Modules <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="build-docker/index.html" title="build-docker">build-docker</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Project Documentation <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li class="dropdown-submenu">
<a href="project-info.html" title="Project Information">Project Information</a>
              <ul class="dropdown-menu">
                  <li><a href="ci-management.html" title="CI Management">CI Management</a></li>
                  <li><a href="dependencies.html" title="Dependencies">Dependencies</a></li>
                  <li><a href="dependency-convergence.html" title="Dependency Convergence">Dependency Convergence</a></li>
                  <li><a href="dependency-info.html" title="Dependency Information">Dependency Information</a></li>
                  <li><a href="distribution-management.html" title="Distribution Management">Distribution Management</a></li>
                  <li><a href="index.html" title="About">About</a></li>
                  <li><a href="issue-management.html" title="Issue Management">Issue Management</a></li>
                  <li><a href="licenses.html" title="Licenses">Licenses</a></li>
                  <li><a href="modules.html" title="Project Modules">Project Modules</a></li>
                  <li><a href="plugin-management.html" title="Plugin Management">Plugin Management</a></li>
                  <li><a href="plugins.html" title="Plugins">Plugins</a></li>
                  <li><a href="scm.html" title="Source Code Management">Source Code Management</a></li>
                  <li><a href="summary.html" title="Summary">Summary</a></li>
                  <li><a href="team.html" title="Team">Team</a></li>
              </ul>
            </li>
            <li class="dropdown-submenu">
<a href="project-reports.html" title="Project Reports">Project Reports</a>
              <ul class="dropdown-menu">
                  <li><a href="surefire-report.html" title="Surefire Report">Surefire Report</a></li>
                  <li><a href="checkstyle.html" title="Checkstyle">Checkstyle</a></li>
                  <li><a href="checkstyle-aggregate.html" title="Checkstyle">Checkstyle</a></li>
                  <li><a href="dependency-check-report.html" title="dependency-check:aggregate">dependency-check:aggregate</a></li>
              </ul>
            </li>
        </ul>
      </li>
            </ul>
            </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>maven-build</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2018-11-22<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 1.0.2</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
    <ul class="nav nav-list">
      <li class="nav-header">DOCUMENTATION</li>
    <li><a href="README.html" title="README"><span class="none"></span>README</a></li>
    <li><a href="GITFLOW_RELEASE.html" title="How to release Apache Maven projects"><span class="none"></span>How to release Apache Maven projects</a></li>
    <li><a href="MVN_DEPLOY_PUBLISH_SEGREGATION.html" title="mvn deploy and artifacts publish segregation"><span class="none"></span>mvn deploy and artifacts publish segregation</a></li>
    <li><a href="TRAVISCI.html" title="travis-ci build"><span class="none"></span>travis-ci build</a></li>
      <li class="nav-header">Projects</li>
    <li><a href="build-docker/index.html" title="build-docker"><span class="none"></span>build-docker</a></li>
    <li><a href="#" title="-----"><span class="none"></span>-----</a></li>
      <li class="nav-header">Modules</li>
    <li><a href="build-docker/index.html" title="build-docker"><span class="none"></span>build-docker</a></li>
      <li class="nav-header">Project Documentation</li>
    <li><a href="project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
</ul>
          <hr />
          <div id="poweredBy">
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<div class="section">
<h2><a name="I._Install_GPG"></a>I. Install GPG</h2>
<p>install (OSX <tt>brew install gpg</tt>) and run <tt>gpg --list-keys to create trustdb.gpg</tt></p></div>
<div class="section">
<h2><a name="II_.Generate_GPG_keys"></a>II .Generate GPG keys</h2>
<div class="section">
<h3><a name="a1._Create_keypair"></a>1. Create keypair</h3>

<div>
<div>
<pre class="source">cat &gt;maven_gpg_key_with_default_algorithms &lt;&lt;EOF
%echo Generating a default key
# Key-Type: DSA
Key-Type: default
Key-Length: 2048
# Subkey-Type: ELG-E
Subkey-Type: default
Name-Real: home1 oss
Name-Comment: with passphrase
Name-Email: opensource@home1.cn
Expire-Date: 0
Passphrase: &lt;passphrase&gt;
%pubring codesigning.pub
%secring codesigning.sec
# Do a commit here, so that we can later print &quot;done&quot; :-)
%commit
%echo done
EOF

gpg --batch --gen-key maven_gpg_key_with_default_algorithms
gpg --import codesigning.pub
</pre></div></div>
</div>
<div class="section">
<h3><a name="a2._Find_the_key_just_created"></a>2. Find the key just created</h3>

<div>
<div>
<pre class="source"># List public keys
gpg --list-keys
# List private keys
gpg --list-secret-keys

# i.e. B24F8E5A595250B60381765A869445475A70DAC8
export CI_OPT_GPG_KEYNAME=$(gpg --list-secret-keys | grep -E '[A-Z0-9]{16,}')
# i.e. 869445475A70DAC8
echo ${CI_OPT_GPG_KEYNAME: -16}
# gpg1
# i.e. 5A70DAC8
echo ${CI_OPT_GPG_KEYNAME: -8}
</pre></div></div>
</div>
<div class="section">
<h3><a name="a3._Send_to_keyserver"></a>3. Send to keyserver</h3>
<p>To make the key accessible for others we should now send it to a keyserver.</p>

<div>
<div>
<pre class="source">gpg --send-key ${CI_OPT_GPG_KEYNAME} --keyserver hkp://pool.sks-keyservers.net
gpg --send-key ${CI_OPT_GPG_KEYNAME} --keyserver hkp://keys.gnupg.net
gpg --send-key ${CI_OPT_GPG_KEYNAME} --keyserver keyserver.pgp.com
gpg --send-key ${CI_OPT_GPG_KEYNAME} --keyserver pgp.mit.edu
gpg --send-key ${CI_OPT_GPG_KEYNAME} --keyserver ha.pool.sks-keyservers.net

# We can also already generate a revocation certificate for the key.
# Should the key be compromised I can send the revocation certificate to the keyserver to invalidate the signing key.
gpg --output revoke-${CI_OPT_GPG_KEYNAME: -16}.asc --gen-revoke ${CI_OPT_GPG_KEYNAME: -16}
</pre></div></div>
</div></div>
<div class="section">
<h2><a name="III._Export_keys_.28Get_codesigning.asc.29"></a>III. Export keys (Get codesigning.asc)</h2>

<div>
<div>
<pre class="source">gpg --export -a ${CI_OPT_GPG_KEYNAME} &gt; codesigning.pub
gpg --export-secret-key -a ${CI_OPT_GPG_KEYNAME} &gt; codesigning.asc
#gpg --export-secret-keys -a ${CI_OPT_GPG_KEYNAME} &gt; codesigning.asc
</pre></div></div>
</div>
<div class="section">
<h2><a name="Iv._Encrypt_the_key_and_make_it_available_to_CI_.28i.e._travis-ci.29"></a>Iv. Encrypt the key and make it available to CI (i.e. travis-ci)</h2>
<div class="section">
<h3><a name="a1._General_way"></a>1. General way</h3>
<p>see: <a class="externalLink" href="https://andreas.heigl.org/2017/01/19/encrypt-a-build-result-automaticaly/">https://andreas.heigl.org/2017/01/19/encrypt-a-build-result-automaticaly/</a></p>

<div>
<div>
<pre class="source"># get a encrypted codesigning.asc.gpg
echo ${CI_OPT_GPG_PASSPHRASE} | gpg --yes --passphrase-fd 0 --use-agent --cipher-algo AES256 -o codesigning.asc.gpg -c codesigning.asc
# decrypt
echo ${CI_OPT_GPG_PASSPHRASE} | gpg --yes --passphrase-fd 0 codesigning.asc.gpg

# import
gpg --yes --batch --import codesigning.asc

# set default key
# interactively
gpg --yes --edit-key ${CI_OPT_GPG_KEYNAME} trust quit
# non-interactively
# see: https://blog.tersmitten.nl/how-to-ultimately-trust-a-public-key-non-interactively.html
echo -e &quot;trust\n5\ny\n&quot; | gpg --command-fd 0 --edit-key ${CI_OPT_GPG_KEYNAME}

# test
echo ${CI_OPT_GPG_PASSPHRASE} | gpg --yes --passphrase-fd 0 -u ${CI_OPT_GPG_KEYNAME} --armor --detach-sig target/checkstyle-result.xml
</pre></div></div>
</div>
<div class="section">
<h3><a name="a2._travis-ci_way"></a>2. travis-ci way</h3>
<p>see: <a class="externalLink" href="https://docs.travis-ci.com/user/encrypting-files/">https://docs.travis-ci.com/user/encrypting-files/</a></p>

<div>
<div>
<pre class="source"># cd project (repository) root, then encrypt
travis encrypt-file codesigning.asc
# decrypt
openssl aes-256-cbc -K $encrypted_0a6446eb3ae3_key -iv $encrypted_0a6446eb3ae3_iv -in codesigning.asc.enc -out codesigning.asc -d
# import
gpg --fast-import codesigning.asc
</pre></div></div>
</div></div>
<div class="section">
<h2><a name="IV._issues"></a>IV. issues</h2>
<div class="section">
<h3><a name="a1._To_fix_issue:_gpg:_signing_failed:_Inappropriate_ioctl_for_device"></a>1. To fix issue: gpg: signing failed: Inappropriate ioctl for device</h3>
<p>1.1. ~/.gnupg/gpg.conf: use-agent pinentry-mode loopback 1.2. ~/.gnupg/gpg-agent.conf: allow-loopback-pinentry 1.3. echo RELOADAGENT | gpg-connect-agent</p></div>
<div class="section">
<h3><a name="a2._travis-ci_.28dist:_trusty.29"></a>2. travis-ci (dist: trusty)</h3>

<div>
<div>
<pre class="source">addons:
  apt:
    packages:
    - gnupg
    - gnupg2
</pre></div></div>

<p>some versions not working on decrypt AES files (encrypted on OSX with gpg1)</p>
<p>Install gpg1 on OSX</p>

<div>
<div>
<pre class="source">brew unlink gpg2
brew install gpg1
export PATH=&quot;/usr/local/opt/gnupg@1.4/libexec/gpgbin:$PATH&quot;
gpg --version
</pre></div></div>

<p>use openssl instead</p>
<p>openssl aes-256-cbc -k ${CI_OPT_GPG_PASSPHRASE} -salt -in codesigning.asc -out codesigning.asc.enc -e openssl aes-256-cbc -k ${CI_OPT_GPG_PASSPHRASE} -in codesigning.asc.enc -out codesigning.asc -d</p></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2018.
All rights reserved.</p>
        </div>
      </div>
    </footer>
  </body>
</html>
